<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Panel del Conductor - Ryan Ruffin</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #202124; color: white; padding: 20px; }
        h1 { color: #8ab4f8; }
        .btn-refresh { padding: 10px 20px; background: #8ab4f8; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        .map-container { background: #3c4043; border-radius: 12px; padding: 10px; margin-bottom: 20px; display: none; }
        .viaje-card { background: #3c4043; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #8ab4f8; }
        .btn-aceptar { background: #34a853; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>
    <h1>Viajes Disponibles</h1>
    <button class="btn-refresh" onclick="cargarViajes()">üîÑ Actualizar Lista</button>

    <div id="contenedor-mapa" class="map-container">
        <h3 style="margin-top:0">üìç Ruta al Destino</h3>
        <iframe id="mapa-seguro" width="100%" height="350" style="border:0; border-radius: 8px;" allowfullscreen></iframe>
    </div>

    <div id="lista-viajes"></div>

    <script>
        // Funci√≥n principal para cargar viajes
        async function cargarViajes() {
            const contenedor = document.getElementById('lista-viajes');
            try {
                const res = await fetch('/api/viajes/pendientes');
                if (!res.ok) throw new Error('Servidor no responde');
                
                const viajes = await res.json();
                const pendientes = viajes.filter(v => v.estado === 'pendiente');

                if (pendientes.length === 0) {
                    contenedor.innerHTML = '<p style="padding: 20px;">No hay viajes nuevos en este momento.</p>';
                    return;
                }

                contenedor.innerHTML = pendientes.map(v => `
                    <div class="viaje-card">
                        <p>üë§ <strong>Pasajero:</strong> ${v.pasajero}</p>
                        <p>üö© <strong>Destino:</strong> ${v.destino}</p>
                        <button class="btn-aceptar" onclick="aceptarViaje('${v._id}', '${v.destino}')">
                            Aceptar Viaje
                        </button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                contenedor.innerHTML = '<p style="color: #ff6b6b;">‚ö†Ô∏è Error: Verifica que el servidor (index.js) est√© encendido.</p>';
            }
        }

        // Funci√≥n para aceptar viaje y mostrar mapa
        async function aceptarViaje(id, destino) {
            try {
                const res = await fetch(`/api/viajes/aceptar/${id}`, { method: 'POST' });
                if (res.ok) {
                    const resMapa = await fetch(`/api/viaje/mapa/${encodeURIComponent(destino)}`);
                    const data = await resMapa.json();
                    
                    document.getElementById('mapa-seguro').src = data.url;
                    document.getElementById('contenedor-mapa').style.display = 'block';
                    alert('¬°Viaje aceptado! Mapa cargado.');
                    cargarViajes();
                }
            } catch (error) {
                alert('No se pudo conectar para aceptar el viaje.');
            }
        }

        // Carga autom√°tica al abrir
        cargarViajes();
    </script>
</body>
</html>